name: 🔗 Check broken links

on:
  workflow_dispatch:
  push:
    paths:
      - '**.md'
  pull_request:
    paths:
      - '**.md'

jobs:
  link-check:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔵 Set up environment
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: 🔍 Scan for broken links with line numbers
        run: |
          echo "🔍 Scanning all Markdown files for broken links with line numbers..."
          errors=0
          while IFS= read -r -d '' file; do
            echo "🔎 Checking $file..."
            lineno=0
            while IFS= read -r line; do
              lineno=$((lineno + 1))
              urls=$(echo "$line" | grep -oP '(?<=\[.*\]\()https?://[^\)\s]+' || true)
              for url in $urls; do
                status=$(curl -o /dev/null -s -w "%{http_code}" "$url" || echo "fail")
                if [[ "$status" != "200" ]]; then
                  echo "❌ [$file:$lineno] $url returned status $status"
                  errors=1
                fi
              done
            done < "$file"
          done < <(find . -name "*.md" -print0)

          if [[ "$errors" -ne 0 ]]; then
            echo "❌ Broken links found. Failing workflow."
            exit 1
          else
            echo "✅ No broken links."
          fi
