name: ğŸ”— Markdown Link Checker

on:
  workflow_dispatch:
  push:
    paths:
      - '**.md'
  pull_request:
    paths:
      - '**.md'

jobs:
  check-links:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Install markdown-link-check
        run: npm install -g markdown-link-check

      - name: ğŸ”— Check all markdown files for broken links
        run: |
          echo "ğŸ” Scanning all Markdown files for broken links with line numbers..."
          status=0
          
          while IFS= read -r -d '' file; do
            echo "ğŸ” Checking $file..."
            lineno=0
            while IFS= read -r line; do
              lineno=$((lineno + 1))
              # Extract URLs from markdown lines
              echo "$line" | grep -Eo '(http|https)://[^)\\s]+' | while read -r url; do
                # Use curl to check the URL status (HEAD request)
                status_code=$(curl -o /dev/null -s -w "%{http_code}" "$url")
                if [ "$status_code" -ge 400 ]; then
                  echo "âŒ [$status_code] $url ($file:$lineno)"
                  status=1
                fi
              done
            done < "$file"
          done < <(find . -name "*.md" -print0)
          
          exit $status
